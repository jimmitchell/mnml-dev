{{- define "main" }}
<main class="archive">
	<article>
		<h1 class="page-title">{{ .Title | safeHTML }}</h1>
		{{- $list := ($.Site.GetPage "taxonomyTerm" "categories").Pages }}
		{{- if and (.Site.Params.show_categories) (gt (len $list) 0) }}
		<div class="archive-categories">
			<div class="category-list">
				{{ range $list }}
				<a href="{{ .Permalink }}"><button>{{ .Title | safeHTML }}</button></a>
				{{ end }}
			</div>
		</div>
		{{- end }}

		{{- $posts := where .Site.RegularPages "Type" "post" }}
		{{- $grouped := $posts.GroupByDate "2006" }}

		<div class="archive_years">
			<select id="archive_popup">
				<option value="all">All Years</option>
				{{ range $grouped }}
				<option value="{{ .Key }}">{{ .Key }}</option>
				{{ end }}
			</select>
		</div>

		<div class="h-feed archive_posts">
			{{- range $grouped }}
				<h3 class="archive-range" data-year="{{ .Key }}">{{ .Key }}</h3>
				{{- range .Pages }}
				<p class="post-date h-entry" data-year="{{ .Date.Format "2006" }}">
					<a href="{{ .Permalink }}">{{- if .Site.Params.use_short_date }}{{ .Date | time.Format ":date_short" }}{{- else }}{{ .Date | time.Format ":date_full" }}{{- end }} â†’</a>
				</p>
				<div class="entry">
					<p>{{- if .Title }}<b>{{ .Title | safeHTML }}:</b>&nbsp;{{- end }}{{ .Summary | safeHTML | truncate 300  }}</p>
				</div>
				{{- end }}
			{{- end }}
		</div>

		<script>
			(function() {
				const select = document.getElementById('archive_popup');

				function filterPosts() {
					const sel = select.value;
					// show/hide each entry
					document.querySelectorAll('.h-feed .h-entry').forEach(el => {
						el.style.display = (sel === "all" || el.getAttribute('data-year') === sel) ? '' : 'none';
					});

					// show/hide each year header based on whether any following .h-entry is visible
					document.querySelectorAll('.h-feed h3[data-year]').forEach(header => {
						let next = header.nextElementSibling;
						let keep = false;
						while (next && !next.matches('h3[data-year]')) {
							if (next.matches('.h-entry') && (next.style.display != 'none')) {
								keep = true; break;
							}
							next = next.nextElementSibling;
						}
						header.style.display = keep ? '' : 'none';
					});
				}

				// on change, re-filter
				select.addEventListener('change', filterPosts);

				// initial filter
				filterPosts();
			})();
		</script>
	</article>
</main>
{{- end }}
